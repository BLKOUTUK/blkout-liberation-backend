/**
 * deployment-realistic-test.js
 * Deployment-realistic test suite that simulates actual production conditions
 * Tests that FAILED to catch the original deployment error - now enhanced
 */

const { spawn } = require('child_process');
const fs = require('fs');
const path = require('path');

console.log('üöÄ DEPLOYMENT-REALISTIC TESTING SUITE\n');

/**
 * TEST 1: Fresh Process Module Loading Simulation
 * Simulates how modules would be loaded in a fresh deployment environment
 */
async function testFreshProcessModuleLoading() {
  console.log('üîÑ TEST 1: Fresh Process Module Loading Simulation');

  return new Promise((resolve) => {
    // Create test script that loads modules in isolation
    const testScript = `
      try {
        console.log('Loading NewsroomLiberationService...');
        const NewsroomLiberationService = require('./layer-3-business-logic/NewsroomLiberationService');
        console.log('‚úÖ NewsroomLiberationService loaded as:', typeof NewsroomLiberationService);

        console.log('Attempting to instantiate NewsroomLiberationService...');
        const instance = new NewsroomLiberationService();
        console.log('‚úÖ NewsroomLiberationService instantiated successfully');

        console.log('Loading EconomicJusticeService...');
        const EconomicJusticeService = require('./layer-3-business-logic/EconomicJusticeService');
        console.log('‚úÖ EconomicJusticeService loaded as:', typeof EconomicJusticeService);

        console.log('Attempting to instantiate EconomicJusticeService...');
        const economicInstance = new EconomicJusticeService();
        console.log('‚úÖ EconomicJusticeService instantiated successfully');

        console.log('Loading API Gateway...');
        const apiGateway = require('./layer-2-api-gateway/api-gateway');
        console.log('‚úÖ API Gateway loaded successfully');

        console.log('‚úÖ ALL MODULE LOADING TESTS PASSED IN FRESH PROCESS');
        process.exit(0);
      } catch (error) {
        console.error('‚ùå FRESH PROCESS MODULE LOADING FAILED:', error.message);
        console.error('Stack trace:', error.stack);
        process.exit(1);
      }
    `;

    // Write temporary test script
    fs.writeFileSync('./temp-fresh-process-test.js', testScript);

    // Execute in fresh Node.js process
    const childProcess = spawn('node', ['./temp-fresh-process-test.js'], {
      cwd: process.cwd(),
      stdio: 'pipe'
    });

    let output = '';
    let errorOutput = '';

    childProcess.stdout.on('data', (data) => {
      output += data.toString();
      console.log('  ' + data.toString().trim());
    });

    childProcess.stderr.on('data', (data) => {
      errorOutput += data.toString();
      console.error('  ERROR:', data.toString().trim());
    });

    childProcess.on('close', (code) => {
      // Clean up temporary file
      if (fs.existsSync('./temp-fresh-process-test.js')) {
        fs.unlinkSync('./temp-fresh-process-test.js');
      }

      const success = code === 0;
      console.log(`  üéØ Fresh Process Module Loading: ${success ? 'PASSED' : 'FAILED'}`);
      if (!success) {
        console.log('  üìã Output:', output);
        console.log('  üö® Error Output:', errorOutput);
      }
      resolve(success);
    });
  });
}

/**
 * TEST 2: Dependency Availability Validation
 * Validates that all required dependencies are available in production-like environment
 */
async function testDependencyAvailability() {
  console.log('\nüì¶ TEST 2: Dependency Availability Validation');

  try {
    // Test critical Node.js built-in modules
    console.log('  üîç Testing Node.js built-in modules...');
    require('events');
    console.log('    ‚úÖ events module available');

    require('fs');
    console.log('    ‚úÖ fs module available');

    require('path');
    console.log('    ‚úÖ path module available');

    // Test if package.json exists and is valid
    console.log('  üìÑ Testing package.json...');
    if (fs.existsSync('./package.json')) {
      const packageJson = JSON.parse(fs.readFileSync('./package.json', 'utf8'));
      console.log('    ‚úÖ package.json exists and is valid JSON');
      console.log('    üìã Dependencies:', Object.keys(packageJson.dependencies || {}));
      console.log('    üìã DevDependencies:', Object.keys(packageJson.devDependencies || {}));
    } else {
      console.log('    ‚ö†Ô∏è package.json not found - this may cause deployment issues');
    }

    // Test module resolution for all our services
    console.log('  üéØ Testing service module resolution...');
    const servicePaths = [
      './layer-3-business-logic/NewsroomLiberationService.js',
      './layer-3-business-logic/EconomicJusticeService.js',
      './layer-5-data-sovereignty/DataSovereigntyService.js',
      './layer-2-api-gateway/api-gateway.js'
    ];

    for (const servicePath of servicePaths) {
      if (fs.existsSync(servicePath)) {
        console.log(`    ‚úÖ ${servicePath} exists and accessible`);
      } else {
        console.log(`    ‚ùå ${servicePath} NOT FOUND`);
        return false;
      }
    }

    console.log('  üéâ Dependency Availability: PASSED');
    return true;

  } catch (error) {
    console.error('  ‚ùå Dependency Availability: FAILED', error.message);
    return false;
  }
}

/**
 * TEST 3: Service Instantiation Order Validation
 * Tests the order in which services must be instantiated to avoid circular dependencies
 */
async function testServiceInstantiationOrder() {
  console.log('\nüîÑ TEST 3: Service Instantiation Order Validation');

  try {
    console.log('  üìä Testing EconomicJusticeService instantiation...');
    const EconomicJusticeService = require('./layer-3-business-logic/EconomicJusticeService');
    const economicService = new EconomicJusticeService();
    console.log('    ‚úÖ EconomicJusticeService instantiated first');

    console.log('  üì∞ Testing NewsroomLiberationService instantiation...');
    const NewsroomLiberationService = require('./layer-3-business-logic/NewsroomLiberationService');
    const newsroomService = new NewsroomLiberationService();
    console.log('    ‚úÖ NewsroomLiberationService instantiated second');

    console.log('  üîí Testing DataSovereigntyService availability...');
    const dataSovereigntyService = require('./layer-5-data-sovereignty/DataSovereigntyService');
    console.log('    ‚úÖ DataSovereigntyService loaded');

    console.log('  üåê Testing API Gateway instantiation...');
    const apiGateway = require('./layer-2-api-gateway/api-gateway');
    console.log('    ‚úÖ API Gateway instantiated with dependency injection');

    // Test that services have expected methods
    console.log('  üß™ Testing service method availability...');
    if (typeof economicService.calculateRevenueTransparency === 'function') {
      console.log('    ‚úÖ EconomicJusticeService.calculateRevenueTransparency available');
    } else {
      throw new Error('EconomicJusticeService.calculateRevenueTransparency not available');
    }

    if (typeof newsroomService.createLiberationContent === 'function') {
      console.log('    ‚úÖ NewsroomLiberationService.createLiberationContent available');
    } else {
      throw new Error('NewsroomLiberationService.createLiberationContent not available');
    }

    console.log('  üéâ Service Instantiation Order: PASSED');
    return true;

  } catch (error) {
    console.error('  ‚ùå Service Instantiation Order: FAILED', error.message);
    return false;
  }
}

/**
 * TEST 4: Production Configuration Validation
 * Simulates production environment variables and configuration
 */
async function testProductionConfigurationValidation() {
  console.log('\n‚öôÔ∏è TEST 4: Production Configuration Validation');

  try {
    // Set production-like environment variables
    process.env.NODE_ENV = 'production';
    process.env.PORT = '3000';

    console.log('  üåç Set production environment variables');
    console.log('    NODE_ENV:', process.env.NODE_ENV);
    console.log('    PORT:', process.env.PORT);

    // Test service behavior in production mode
    console.log('  üß™ Testing services in production mode...');

    // Use dependency injection instead of direct instantiation
    const { bootstrapServices, createAPILayerServices } = require('./dependency-injection/ServiceRegistry');
    bootstrapServices();
    const services = createAPILayerServices();
    const newsroomService = services.newsroom;

    // Test basic functionality in production mode
    const testContent = {
      title: 'Production Test Article',
      body: 'Testing production deployment',
      revenue: 100
    };

    const result = newsroomService.createLiberationContent(testContent);
    if (result.content && result.content.liberationValues.creatorSovereignty >= 0.75) {
      console.log('    ‚úÖ Service functions correctly in production mode');
    } else {
      throw new Error('Service failed to maintain liberation values in production mode');
    }

    console.log('  üéâ Production Configuration: PASSED');
    return true;

  } catch (error) {
    console.error('  ‚ùå Production Configuration: FAILED', error.message);
    return false;
  } finally {
    // Reset environment
    delete process.env.NODE_ENV;
    delete process.env.PORT;
  }
}

/**
 * Main test runner for deployment-realistic tests
 */
async function runDeploymentRealisticTests() {
  console.log('üèÅ STARTING DEPLOYMENT-REALISTIC TESTS\n');

  const results = {
    freshProcessModuleLoading: false,
    dependencyAvailability: false,
    serviceInstantiationOrder: false,
    productionConfiguration: false
  };

  // Run all tests
  results.freshProcessModuleLoading = await testFreshProcessModuleLoading();
  results.dependencyAvailability = await testDependencyAvailability();
  results.serviceInstantiationOrder = await testServiceInstantiationOrder();
  results.productionConfiguration = await testProductionConfigurationValidation();

  // Summary
  const totalTests = Object.keys(results).length;
  const passedTests = Object.values(results).filter(result => result === true).length;

  console.log('\nüìä DEPLOYMENT-REALISTIC TEST RESULTS:');
  console.log(`  Total Tests: ${totalTests}`);
  console.log(`  Passed: ${passedTests}`);
  console.log(`  Failed: ${totalTests - passedTests}`);
  console.log(`  Success Rate: ${((passedTests / totalTests) * 100).toFixed(1)}%`);

  // Detailed results
  console.log('\nüìã DETAILED RESULTS:');
  Object.entries(results).forEach(([testName, passed]) => {
    const status = passed ? '‚úÖ PASSED' : '‚ùå FAILED';
    console.log(`  ${testName}: ${status}`);
  });

  // Final verdict
  const allTestsPassed = passedTests === totalTests;
  console.log('\nüéØ FINAL VERDICT:');
  if (allTestsPassed) {
    console.log('üéâ ALL DEPLOYMENT-REALISTIC TESTS PASSED!');
    console.log('‚úÖ Services should deploy correctly in production');
    console.log('‚úÖ Module loading patterns are deployment-compatible');
    console.log('‚úÖ Dependencies are properly configured');
    console.log('‚úÖ Service instantiation order is correct');
    console.log('‚úÖ Production configuration is valid');
  } else {
    console.log('‚ö†Ô∏è SOME DEPLOYMENT-REALISTIC TESTS FAILED');
    console.log('üö® Deployment may fail in production environment');
    console.log('üí° Review failed tests and fix issues before deploying');
  }

  return allTestsPassed;
}

// Run tests if this file is executed directly
if (require.main === module) {
  runDeploymentRealisticTests().then(success => {
    process.exit(success ? 0 : 1);
  }).catch(error => {
    console.error('üö® Deployment-realistic test runner error:', error);
    process.exit(1);
  });
}

module.exports = { runDeploymentRealisticTests };